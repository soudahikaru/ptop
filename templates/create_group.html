{% extends 'base.html' %}

{% block header %}

{% load static %}
<script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
{% load bootstrap4 %}{% bootstrap_css %}{% bootstrap_javascript jquery='full' %}

<style>
.input-inline { display: inline-block; width: 150px; }
.helptext {font-size: small;}
.required {color: red;}
</style>

{% endblock header %}

{% block content %}
<div class="container">
  <div class="card">
    {% if 'update' in request.path %}
    <h5 class="card-header">トラブル類型編集</h5>
    {% else %}
    <h5 class="card-header">新規トラブル類型入力</h5>
    {% endif %}

    <div class="card-body">
      <form action="" method="POST">
        {% csrf_token %}
        <table border>
          {% for field in form %}
          {% spaceless %}
          <tr><th>{% if field.field.required %}<span class="required">*</span>{% endif %}{{ field.label_tag }}</th><td>{{ field }}
            {% if "device" in field.id_for_label %}
              <a href="javascript:void(0);" onclick="window.open('{% url 'ptop:popup_device_create' %}', 'subwin','width=500,height=500');" class="btn btn-info btn-sm">追加</a>
            {% elif "error" in field.id_for_label %}
              <a href="javascript:void(0);" onclick="window.open('{% url 'ptop:popup_error_create' %}', 'subwin','width=500,height=500');" class="btn btn-info btn-sm">追加</a>
            {% elif "attachments" in field.id_for_label %}
                <button type="button" class="btn btn-info js-upload-photos">
                <span class="glyphicon glyphicon-cloud-upload"></span> 添付ファイルのアップロード
                </button>
            {% endif %}
            {% if field.help_text %}
              <span class="helptext">{{ field.help_text|safe }}</span>
            {% endif %}
          </td></tr>
          {% endspaceless %}
          {% endfor %}
        </table>
  
        <div>
          <input id="fileupload" type="file" name="file" multiple
          style="display: none;"
          data-url="{{ request.build_absolute_url }}"
          data-form-data='{"csrfmiddlewaretoken": "{{ csrf_token }}"}'>
        </div>
    
        {% if 'update' in request.path %}
        <input class="btn btn-primary" type="submit" value="入力した内容で更新する">
        {% else %}
        <input class="btn btn-primary" type="submit" value="トラブル類型を作成する">
        {% endif %}
        {{form.media}}
      </form>
      
    </div>      
  </div>
  <a href="{% url 'ptop:home' %}" class="btn btn-primary">戻る</a>

</div>

<script src="{% static 'ptop/js/jquery-3.1.1.min.js' %}"></script>
<script src="{% static 'ptop/js/bootstrap.min.js' %}"></script>
{# JQUERY FILE UPLOAD SCRIPTS #}
<script src="{% static 'ptop/js/jquery-file-upload/vendor/jquery.ui.widget.js' %}"></script>
<script src="{% static 'ptop/js/jquery-file-upload/jquery.iframe-transport.js' %}"></script>
<script src="{% static 'ptop/js/jquery-file-upload/jquery.fileupload.js' %}"></script>

{# PHOTOS PAGE SCRIPTS #}
<script src="{% static 'ptop/js/basic-upload.js' %}"></script>

{% endblock content %}

{% block javascript %}
<script>
    /*
    On focus out on input nickname,
    call AJAX get request to check if the nickName
    already exists or not.
    */
    function formatDate(dt) {
      var y = dt.getFullYear();
      var m = ('00' + (dt.getMonth()+1)).slice(-2);
      var d = ('00' + dt.getDate()).slice(-2);
      var h = ('00' + dt.getHours()).slice(-2);
      var min = ('00' + dt.getMinutes()).slice(-2);
      return (y + '-' + m + '-' + d + ' ' + h + ':' + min);
    }

    $(function () {
//      $(".js-upload-photos").click(function () {
//        $("#fileupload").click();
//      });
      $("#fileupload").fileupload({
        dataType: 'json',
        autoUpload: true,
        done: function (e, data) {  /* 3. PROCESS THE RESPONSE FROM THE SERVER */
          console.log("done")
          if (data.result.is_valid) {
  //          var list = $("#id_attachments").val();
  //          list.push(data.result.pk);
            console.log(data.result.pk)
            $option = $('<option>')
              .val(data.result.pk)
              .text(data.result.title)
              .prop('selected', true);
            $("#id_attachments").append($option);
  //          $("#id_attachments").val(list);
          }
        },
        fail: function(e, data) {
          alert('Fail!');
        }
      });
    });


</script>
{% endblock javascript %}
